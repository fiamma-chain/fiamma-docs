# 7. Pause and Quit

This guide covers graceful shutdown procedures for your **mainnet production** Fiamma Operator, including temporary pausing and permanent withdrawal.

## ⚠️ Production Environment Considerations

**Critical**: Pausing or quitting involves real Bitcoin stakes and operational commitments. Understand all implications before proceeding.

## Overview

Production operators may need to:
- **Temporarily pause** operations for maintenance
- **Gracefully quit** to exit operator role
- **Emergency shutdown** during critical situations
- **Planned migration** to new infrastructure

## Temporary Pause Operations

### When to Pause

Appropriate scenarios for pausing:
- **Scheduled maintenance** windows
- **System upgrades** requiring service restart
- **Infrastructure changes** (IP, network, etc.)
- **Short-term unavailability** (< 24 hours)

### Pause Process

#### Step 1: Prepare for Pause

```bash
# Check current operator status
echo "=== Pre-Pause Status Check ==="
systemctl status fiamma-operator || systemctl --user status fiamma-operator

# Check pending operations
grep -i "pending\|processing" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -10

# Verify stake status
grep -i "stake.*active" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -1

# Create pause-time backup
mkdir -p /var/backups/fiamma-operator/pause/$(date +%Y%m%d_%H%M)
cp .env /var/backups/fiamma-operator/pause/$(date +%Y%m%d_%H%M)/
```

#### Step 2: Graceful Service Stop

```bash
# Stop the service gracefully
echo "=== Stopping Operator Service ==="
sudo systemctl stop fiamma-operator || systemctl --user stop fiamma-operator

# Wait for graceful shutdown
sleep 30

# Verify service is stopped
systemctl is-active fiamma-operator 2>/dev/null || systemctl --user is-active fiamma-operator 2>/dev/null
if [ $? -eq 0 ]; then
    echo "Warning: Service still running"
else
    echo "Service stopped successfully"
fi
```

#### Step 3: Monitor for Completion

```bash
# Check final log entries
echo "=== Final Operations ==="
tail -20 .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log

# Look for graceful shutdown indicators:
# - "Operator paused successfully"
# - "All operations completed"
# - "Service stopped gracefully"
```

### Resume from Pause

```bash
# Resume operations after pause
echo "=== Resuming Operator Operations ==="

# Start the service
sudo systemctl start fiamma-operator || systemctl --user start fiamma-operator

# Verify startup
sleep 10
systemctl status fiamma-operator || systemctl --user status fiamma-operator

# Monitor resume logs
tail -f .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | head -20

# Verify operational status
grep -i "resumed\|started\|active" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -5
```

## Permanent Quit Process

### Pre-Quit Requirements

Before permanently quitting:
- **Complete all pending operations**
- **Understand withdrawal lock periods**
- **Plan for stake withdrawal**
- **Backup all critical data**
- **Notify Fiamma team** (if required)

### Step 1: Initiate Quit Process

```bash
# Create comprehensive pre-quit backup
QUIT_BACKUP="/var/backups/fiamma-operator/quit/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$QUIT_BACKUP"

echo "=== Pre-Quit Backup ==="
cp .env "$QUIT_BACKUP/"
cp -r dal/ "$QUIT_BACKUP/"
cp fiamma-operator "$QUIT_BACKUP/"

# Document current state
./fiamma-operator --version > "$QUIT_BACKUP/version_info.txt" 2>&1
systemctl status fiamma-operator > "$QUIT_BACKUP/service_status.txt" 2>&1 || systemctl --user status fiamma-operator > "$QUIT_BACKUP/service_status.txt" 2>&1

# Document stake information
grep -i "stake" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -10 > "$QUIT_BACKUP/stake_info.txt"
```

### Step 2: Initiate Withdrawal

```bash
# Check withdrawal requirements
echo "=== Withdrawal Process ==="

# Note: Withdrawal process depends on operator implementation
# This may involve:
# 1. API calls to initiate withdrawal
# 2. Waiting for lock periods to expire
# 3. Signing withdrawal transactions
# 4. Monitoring withdrawal completion

# Example withdrawal command (adjust based on actual implementation):
# ./fiamma-operator withdraw --amount all --address your_bitcoin_address

# Monitor withdrawal status
grep -i "withdraw\|quit" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log
```

### Step 3: Monitor Withdrawal

```bash
# Create withdrawal monitoring script
cat > monitor_withdrawal.sh << 'EOF'
#!/bin/bash

echo "=== Withdrawal Monitoring - $(date) ==="

# Check withdrawal status in logs
echo "Recent withdrawal activity:"
grep -i "withdraw\|unstake\|exit" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -10

# Check Bitcoin network for withdrawal transaction
echo "Monitor Bitcoin network for withdrawal transaction"
echo "Use blockchain explorer: https://blockstream.info/"

# Check operator status
echo "Current operator status:"
systemctl is-active fiamma-operator 2>/dev/null || systemctl --user is-active fiamma-operator 2>/dev/null || echo "Service stopped"

# Check remaining stake
echo "Checking remaining stake status..."
grep -i "stake.*remain\|balance" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -3
EOF

chmod +x monitor_withdrawal.sh
```

### Step 4: Final Cleanup

```bash
# After successful withdrawal completion
echo "=== Final Cleanup ==="

# Stop and disable service
sudo systemctl stop fiamma-operator || systemctl --user stop fiamma-operator
sudo systemctl disable fiamma-operator || systemctl --user disable fiamma-operator

# Remove service files (optional)
sudo rm -f /etc/systemd/system/fiamma-operator* || true
systemctl --user daemon-reload || sudo systemctl daemon-reload

# Secure cleanup of sensitive data
echo "Securely cleaning sensitive data..."
shred -u .env 2>/dev/null || rm -f .env
shred -u dal/.env 2>/dev/null || rm -f dal/.env

# Archive final state
FINAL_ARCHIVE="/var/backups/fiamma-operator/final_state_$(date +%Y%m%d_%H%M%S).tar.gz"
tar czf "$FINAL_ARCHIVE" .logs/ dal/ *.sh
echo "Final state archived: $FINAL_ARCHIVE"
```

## Emergency Shutdown

### Critical Situations

Emergency shutdown may be required for:
- **Security breaches** or compromise detected
- **System failures** threatening stake safety
- **Network issues** causing operational problems
- **Hardware failures** requiring immediate action

### Emergency Procedure

```bash
# Create emergency shutdown script
cat > emergency_shutdown.sh << 'EOF'
#!/bin/bash

echo "=== EMERGENCY SHUTDOWN - $(date) ==="
echo "REASON: $1"

# Immediate service stop
sudo systemctl stop fiamma-operator || systemctl --user stop fiamma-operator

# Kill processes if needed
pkill -f fiamma-operator || echo "No processes to kill"

# Quick backup of critical data
EMERGENCY_BACKUP="/var/backups/fiamma-operator/emergency/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$EMERGENCY_BACKUP"
cp .env "$EMERGENCY_BACKUP/" 2>/dev/null || echo "No .env to backup"
cp -r dal/ "$EMERGENCY_BACKUP/" 2>/dev/null || echo "No dal/ to backup"

# Document emergency state
echo "Emergency shutdown: $1" > "$EMERGENCY_BACKUP/emergency_reason.txt"
date >> "$EMERGENCY_BACKUP/emergency_reason.txt"
tail -50 .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log > "$EMERGENCY_BACKUP/final_logs.txt" 2>/dev/null || echo "No logs available"

# Disable auto-restart
sudo systemctl disable fiamma-operator 2>/dev/null || systemctl --user disable fiamma-operator 2>/dev/null || echo "Service already disabled"

# Send emergency alert
echo "EMERGENCY SHUTDOWN on $(hostname): $1" | mail -s "EMERGENCY: Operator Shutdown" admin@yourdomain.com 2>/dev/null || echo "Email alert failed"

echo "=== Emergency shutdown complete ==="
echo "Backup location: $EMERGENCY_BACKUP"
echo "Contact Fiamma support immediately if stake is at risk"
EOF

chmod +x emergency_shutdown.sh

# Usage: ./emergency_shutdown.sh "Reason for emergency shutdown"
```

## Migration to New Infrastructure

### Planned Migration Process

```bash
# Create migration planning script
cat > plan_migration.sh << 'EOF'
#!/bin/bash

echo "=== Migration Planning - $(date) ==="

# 1. Document current setup
echo "Current operator configuration:"
./fiamma-operator --version
systemctl status fiamma-operator || systemctl --user status fiamma-operator

# 2. Create migration backup
MIGRATION_BACKUP="/var/backups/fiamma-operator/migration/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$MIGRATION_BACKUP"

# Full configuration backup
cp .env "$MIGRATION_BACKUP/"
cp -r dal/ "$MIGRATION_BACKUP/"
cp fiamma-operator "$MIGRATION_BACKUP/"
cp *.sh "$MIGRATION_BACKUP/"

# Service configuration
sudo cp /etc/systemd/system/fiamma-operator* "$MIGRATION_BACKUP/" 2>/dev/null || true

# Create migration checklist
cat > "$MIGRATION_BACKUP/migration_checklist.txt" << 'CHECKLIST'
Migration Checklist:
□ Backup current setup
□ Set up new infrastructure
□ Test new environment
□ Plan migration timing
□ Coordinate with Fiamma team
□ Execute migration
□ Verify new setup
□ Decommission old setup
CHECKLIST

echo "Migration backup created: $MIGRATION_BACKUP"
echo "Review migration_checklist.txt before proceeding"
EOF

chmod +x plan_migration.sh
```

## Recovery After Quit

### Re-entering as Operator

If you need to become an operator again:

```bash
# Steps to re-enter (general process):
# 1. Contact Fiamma team for new registration
# 2. Obtain new production invite code
# 3. Set up fresh environment
# 4. Complete registration process
# 5. Stake new Bitcoin amount
# 6. Begin operations

echo "To re-enter as operator:"
echo "1. Contact Fiamma team"
echo "2. Follow initial setup guide"
echo "3. Complete new registration"
echo "4. Stake required Bitcoin"
```

## Support and Documentation

### Post-Quit Support

- **Withdrawal Issues**: Financial operations team
- **Technical Problems**: Technical support
- **Re-entry Questions**: Registration team
- **Emergency Situations**: 24/7 priority support

### Documentation

```bash
# Create quit documentation
cat > quit_documentation.md << 'EOF'
# Operator Quit Documentation

## Quit Date
[Date of quit]

## Reason for Quit
[Reason for quitting operator role]

## Final Status
- Stake Amount: [Amount]
- Withdrawal Status: [Completed/Pending]
- Service Status: [Stopped/Removed]

## Backup Locations
- Configuration: [Backup location]
- Final Logs: [Log location]
- Service Files: [Service backup location]

## Notes
[Any additional notes or lessons learned]

## Re-entry Information
- Contact: [Fiamma team contact]
- Requirements: [Any special requirements for re-entry]
EOF
```

## Next Steps

After quitting:

1. **Monitor withdrawal** completion on Bitcoin network
2. **Secure all backups** and documentation
3. **Complete final cleanup** of sensitive data
4. **Contact Fiamma team** if re-entry planned
5. **Document lessons learned** for future reference

---

**Important**: This completes the operator lifecycle. For troubleshooting any issues during quit process, proceed to [Troubleshooting](8.-troubleshooting.md).
