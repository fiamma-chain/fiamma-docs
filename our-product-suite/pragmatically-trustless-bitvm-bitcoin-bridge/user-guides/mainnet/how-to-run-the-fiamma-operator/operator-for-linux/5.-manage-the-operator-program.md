# 5. Manage the Operator Program

This guide covers ongoing management, maintenance, and upgrade procedures for your **mainnet production** Fiamma Operator.

## Overview

Production operator management involves:
- **Regular maintenance** and health checks
- **Software updates** and security patches
- **Performance optimization** and scaling
- **Backup and recovery** procedures
- **Emergency response** protocols

## Regular Maintenance

### Daily Operations

```bash
# Daily health check routine
echo "=== Daily Operator Health Check - $(date) ==="

# 1. Service status
systemctl is-active fiamma-operator || systemctl --user is-active fiamma-operator

# 2. Recent errors (last 24 hours)
grep -i "error\|warn\|critical" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | wc -l

# 3. Stake status
grep -i "stake.*active\|stake.*status" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -1

# 4. System resources
df -h / && free -m | head -2

# 5. Network connectivity
ping -c 1 8.8.8.8 >/dev/null && echo "Network: OK" || echo "Network: FAILED"
```

### Weekly Maintenance

```bash
# Create weekly maintenance script
cat > weekly_maintenance.sh << 'EOF'
#!/bin/bash

echo "=== Weekly Maintenance - $(date) ==="

# 1. Update system packages (non-interactive)
sudo apt update
sudo apt list --upgradable

# 2. Clean up old logs (keep last 30 days)
find .logs/ -name "*.log" -type f -mtime +30 -delete

# 3. Database maintenance
cd dal
sqlx migrate status
cd ..

# 4. Check disk usage
du -sh .logs/ database/ || echo "Checking disk usage..."

# 5. Backup configuration files
mkdir -p /var/backups/fiamma-operator/weekly/$(date +%Y%W)
cp .env /var/backups/fiamma-operator/weekly/$(date +%Y%W)/env_backup_$(date +%Y%m%d)
cp -r dal/ /var/backups/fiamma-operator/weekly/$(date +%Y%W)/dal_backup_$(date +%Y%m%d)/

# 6. Performance metrics
echo "CPU/Memory usage trend:"
top -b -n 1 | head -5

echo "=== Weekly Maintenance Complete ==="
EOF

chmod +x weekly_maintenance.sh
```

## Software Updates and Upgrades

### Pre-Upgrade Checklist

Before performing any upgrades:

```bash
# 1. Create comprehensive backup
mkdir -p /var/backups/fiamma-operator/pre-upgrade/$(date +%Y%m%d_%H%M)
BACKUP_DIR="/var/backups/fiamma-operator/pre-upgrade/$(date +%Y%m%d_%H%M)"

# Backup configuration
cp .env "$BACKUP_DIR/"
cp -r dal/ "$BACKUP_DIR/"

# Backup service files
sudo cp /etc/systemd/system/fiamma-operator* "$BACKUP_DIR/" 2>/dev/null || true

# Backup current binary
cp fiamma-operator "$BACKUP_DIR/fiamma-operator.backup"

# Document current version
./fiamma-operator --version > "$BACKUP_DIR/version_info.txt" 2>&1
systemctl status fiamma-operator >> "$BACKUP_DIR/service_status.txt" 2>&1 || systemctl --user status fiamma-operator >> "$BACKUP_DIR/service_status.txt" 2>&1
```

### Upgrade Process

#### Step 1: Verify Database Status

```bash
# Ensure database is healthy before upgrade
echo "=== Pre-Upgrade Database Check ==="
sudo docker ps | grep postgres

# Test database connectivity
cd dal
sqlx database ping --database-url $(grep DATABASE_URL .env | cut -d '=' -f2) && echo "Database: Ready for upgrade" || echo "Database: Issues detected"
cd ..
```

#### Step 2: Download Latest Updates

```bash
# Pull latest updates from repository
git stash  # Save any local changes
git pull origin main

# Verify update contents
git log --oneline -10
git diff HEAD~1 HEAD --name-only
```

#### Step 3: Apply Database Migrations

```bash
# Run database schema updates
cd dal
echo "=== Applying Database Migrations ==="
sqlx migrate run

# Verify migration status
sqlx migrate status
cd ..
```

#### Step 4: Update Dependencies

```bash
# Update Rust dependencies if needed
rustup update
cargo update

# Update system packages (if safe to do so)
sudo apt update
sudo apt upgrade -y
```

#### Step 5: Restart Services

```bash
# Graceful service restart
echo "=== Restarting Operator Service ==="

# Stop service
sudo systemctl stop fiamma-operator || systemctl --user stop fiamma-operator

# Wait for graceful shutdown
sleep 10

# Start service
sudo systemctl start fiamma-operator || systemctl --user start fiamma-operator

# Verify restart
sleep 5
systemctl is-active fiamma-operator || systemctl --user is-active fiamma-operator
```

#### Step 6: Post-Upgrade Verification

```bash
# Verify upgrade success
echo "=== Post-Upgrade Verification ==="

# Check service status
systemctl status fiamma-operator || systemctl --user status fiamma-operator

# Monitor logs for successful startup
tail -20 .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log

# Verify functionality
grep -i "started\|initialized\|ready" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -5

# Check stake status
grep -i "stake.*active" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -1
```

### Rollback Procedures

If upgrade fails, rollback immediately:

```bash
# Emergency rollback script
cat > emergency_rollback.sh << 'EOF'
#!/bin/bash

echo "=== EMERGENCY ROLLBACK - $(date) ==="

# Find latest backup
LATEST_BACKUP=$(ls -t /var/backups/fiamma-operator/pre-upgrade/ | head -1)
BACKUP_PATH="/var/backups/fiamma-operator/pre-upgrade/$LATEST_BACKUP"

echo "Rolling back to: $BACKUP_PATH"

# Stop current service
sudo systemctl stop fiamma-operator || systemctl --user stop fiamma-operator

# Restore configuration
cp "$BACKUP_PATH/.env" ./
cp -r "$BACKUP_PATH/dal/" ./

# Restore binary
cp "$BACKUP_PATH/fiamma-operator.backup" ./fiamma-operator
chmod +x fiamma-operator

# Restore service files
sudo cp "$BACKUP_PATH"/fiamma-operator* /etc/systemd/system/ 2>/dev/null || true
sudo systemctl daemon-reload

# Start service
sudo systemctl start fiamma-operator || systemctl --user start fiamma-operator

# Verify rollback
systemctl status fiamma-operator || systemctl --user status fiamma-operator

echo "=== Rollback Complete ==="
EOF

chmod +x emergency_rollback.sh
```

## Performance Optimization

### Resource Monitoring and Tuning

```bash
# Create performance monitoring script
cat > monitor_performance.sh << 'EOF'
#!/bin/bash

echo "=== Performance Report - $(date) ==="

# CPU usage
echo "CPU Usage:"
top -b -n 1 | grep "Cpu(s)" || top -b -n 1 | head -3

# Memory usage
echo "Memory Usage:"
free -h

# Disk I/O
echo "Disk Usage:"
df -h | grep -E "(Filesystem|/dev/)"
iostat -d 1 1 | tail -n +4

# Network statistics
echo "Network Statistics:"
ss -s

# Process-specific metrics
echo "Operator Process:"
ps aux | grep fiamma-operator | grep -v grep
EOF

chmod +x monitor_performance.sh
```

### Database Optimization

```bash
# Database maintenance script
cat > optimize_database.sh << 'EOF'
#!/bin/bash

echo "=== Database Optimization - $(date) ==="

cd dal

# Check database size
echo "Database size:"
sudo docker exec $(sudo docker ps | grep postgres | awk '{print $1}') psql -U postgres -c "SELECT pg_database_size('fiamma_operator');"

# Vacuum and analyze
echo "Running vacuum and analyze..."
sudo docker exec $(sudo docker ps | grep postgres | awk '{print $1}') psql -U postgres -d fiamma_operator -c "VACUUM ANALYZE;"

# Check for slow queries (if logging enabled)
echo "Recent slow queries:"
sudo docker exec $(sudo docker ps | grep postgres | awk '{print $1}') psql -U postgres -d fiamma_operator -c "SELECT query, calls, total_time, mean_time FROM pg_stat_statements ORDER BY total_time DESC LIMIT 5;" 2>/dev/null || echo "Query statistics not available"

cd ..
EOF

chmod +x optimize_database.sh
```

## Backup and Recovery

### Automated Backup Strategy

```bash
# Create comprehensive backup script
cat > backup_operator.sh << 'EOF'
#!/bin/bash

BACKUP_ROOT="/var/backups/fiamma-operator"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="$BACKUP_ROOT/automated/$DATE"

mkdir -p "$BACKUP_DIR"

echo "=== Automated Backup - $(date) ==="

# Configuration backup
echo "Backing up configuration..."
cp .env "$BACKUP_DIR/env_backup"
cp -r dal/ "$BACKUP_DIR/dal_backup/"

# Service configuration
echo "Backing up service files..."
sudo cp /etc/systemd/system/fiamma-operator* "$BACKUP_DIR/" 2>/dev/null || true

# Database backup
echo "Backing up database..."
sudo docker exec $(sudo docker ps | grep postgres | awk '{print $1}') pg_dump -U postgres fiamma_operator > "$BACKUP_DIR/database_backup.sql"

# Logs backup (last 7 days)
echo "Backing up recent logs..."
find .logs/ -name "*.log" -mtime -7 -exec cp {} "$BACKUP_DIR/" \;

# Binary backup
echo "Backing up binary..."
cp fiamma-operator "$BACKUP_DIR/fiamma-operator.backup"

# Create metadata
cat > "$BACKUP_DIR/backup_metadata.txt" << METADATA
Backup Date: $(date)
Operator Version: $(./fiamma-operator --version 2>&1)
System Info: $(uname -a)
Service Status: $(systemctl is-active fiamma-operator 2>/dev/null || systemctl --user is-active fiamma-operator 2>/dev/null)
METADATA

# Compress backup
cd "$BACKUP_ROOT/automated"
tar czf "operator_backup_$DATE.tar.gz" "$DATE/"
rm -rf "$DATE/"

# Clean old backups (keep last 30 days)
find "$BACKUP_ROOT/automated" -name "operator_backup_*.tar.gz" -mtime +30 -delete

echo "Backup completed: operator_backup_$DATE.tar.gz"
EOF

chmod +x backup_operator.sh

# Add to crontab for daily backups
(crontab -l 2>/dev/null; echo "0 3 * * * cd $(pwd) && ./backup_operator.sh >> /var/log/operator_backup.log 2>&1") | crontab -
```

### Recovery Procedures

```bash
# Create recovery script
cat > recover_operator.sh << 'EOF'
#!/bin/bash

if [ $# -ne 1 ]; then
    echo "Usage: $0 <backup_file.tar.gz>"
    echo "Available backups:"
    ls -la /var/backups/fiamma-operator/automated/operator_backup_*.tar.gz | tail -10
    exit 1
fi

BACKUP_FILE="$1"
RECOVERY_DIR="/tmp/operator_recovery_$(date +%Y%m%d_%H%M%S)"

echo "=== Recovery Process - $(date) ==="
echo "Recovering from: $BACKUP_FILE"

# Extract backup
mkdir -p "$RECOVERY_DIR"
cd "$RECOVERY_DIR"
tar xzf "$BACKUP_FILE"

EXTRACTED_DIR=$(ls -d */ | head -1)
cd "$EXTRACTED_DIR"

echo "Backup contents:"
ls -la

# Stop current service
echo "Stopping current service..."
sudo systemctl stop fiamma-operator || systemctl --user stop fiamma-operator

# Restore configuration
echo "Restoring configuration..."
cp env_backup "$(pwd)/.env"
cp -r dal_backup/ "$(pwd)/dal/"

# Restore database
echo "Restoring database..."
sudo docker exec -i $(sudo docker ps | grep postgres | awk '{print $1}') psql -U postgres -d fiamma_operator < database_backup.sql

# Restore binary
echo "Restoring binary..."
cp fiamma-operator.backup "$(pwd)/fiamma-operator"
chmod +x "$(pwd)/fiamma-operator"

# Start service
echo "Starting service..."
sudo systemctl start fiamma-operator || systemctl --user start fiamma-operator

# Verify recovery
sleep 5
systemctl status fiamma-operator || systemctl --user status fiamma-operator

echo "=== Recovery Complete ==="
EOF

chmod +x recover_operator.sh
```

## Emergency Procedures

### Service Failure Response

```bash
# Create emergency response script
cat > emergency_response.sh << 'EOF'
#!/bin/bash

echo "=== EMERGENCY RESPONSE - $(date) ==="

# Check what's wrong
echo "Diagnosing issue..."

# Service status
SERVICE_STATUS=$(systemctl is-active fiamma-operator 2>/dev/null || systemctl --user is-active fiamma-operator 2>/dev/null)
echo "Service Status: $SERVICE_STATUS"

# Recent errors
echo "Recent errors:"
grep -i "error\|critical\|fatal" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -10

# System resources
echo "System resources:"
df -h | head -5
free -m | head -2

# Emergency restart
if [ "$SERVICE_STATUS" != "active" ]; then
    echo "Attempting emergency restart..."
    sudo systemctl restart fiamma-operator || systemctl --user restart fiamma-operator
    sleep 10
    systemctl status fiamma-operator || systemctl --user status fiamma-operator
fi

# Send alert
echo "Emergency situation detected on $(hostname) at $(date)" | mail -s "EMERGENCY: Operator Issue" admin@yourdomain.com 2>/dev/null || echo "Alert email failed"

echo "=== Emergency Response Complete ==="
EOF

chmod +x emergency_response.sh
```

### Disaster Recovery Planning

```bash
# Document disaster recovery procedures
cat > disaster_recovery_plan.md << 'EOF'
# Disaster Recovery Plan

## Emergency Contacts
- Primary: [Your emergency contact]
- Secondary: [Backup contact]
- Fiamma Support: [Support contact]

## Critical Recovery Steps
1. Assess situation severity
2. Stop further damage (stop services if needed)
3. Restore from latest backup
4. Verify stake safety
5. Contact Fiamma team if stake at risk
6. Document incident for post-mortem

## Recovery Priorities
1. Stake protection (highest priority)
2. Service restoration
3. Data integrity
4. Performance optimization

## Backup Locations
- Local: /var/backups/fiamma-operator/
- Remote: [Configure remote backup location]
- Cloud: [Configure cloud backup if applicable]
EOF
```

## Next Steps

For advanced security and operational procedures:

1. **Proceed to [Advanced Security Setup](6.-advanced-security-setup.md)** for GPG encryption
2. **Set up automated monitoring** and alerting
3. **Implement backup verification** procedures
4. **Document custom operational procedures**

## Support

For management and maintenance assistance:
- **Upgrade Issues**: Technical support team
- **Performance Problems**: Optimization specialists
- **Backup/Recovery**: Data management team
- **Emergency Support**: 24/7 priority channels

---

**Next**: For enhanced security, proceed to [Advanced Security Setup](6.-advanced-security-setup.md), or continue to [Pause and Quit](7.-pause-and-quit.md) for graceful shutdown procedures.
