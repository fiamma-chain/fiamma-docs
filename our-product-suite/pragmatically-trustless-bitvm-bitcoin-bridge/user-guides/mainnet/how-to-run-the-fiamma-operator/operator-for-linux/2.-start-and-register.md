# 2. Start and Register

This guide covers starting the Fiamma Operator service and registering for **mainnet production** operations.

## ⚠️ Production Registration

**Critical**: This process involves real Bitcoin staking and production registration. Ensure you have proper authorization and understand all financial implications.

## Prerequisites

Before starting registration:
- **Completed setup** from [previous step](1.-set-up-fiamma-operator.md)
- **Production invite code** from Fiamma team
- **Real Bitcoin** ready for staking
- **Secure private keys** prepared
- **Production environment** validated

## Environment Configuration

### Configure Private Keys

Edit the `.env` file to set your production private keys:

```bash
# Open environment configuration securely
vim .env

# Set these required private keys:
BITVM_BRIDGE_OPERATOR_AUTH_SK=your_production_auth_private_key
BITVM_BRIDGE_OPERATOR_PEGIN_SK=your_production_pegin_private_key
BITVM_BRIDGE_OPERATOR_PEGOUT_SK=your_production_pegout_private_key
BITVM_BRIDGE_OPERATOR_ETH_SK=0xYourEvmPrivateKey
```

**🔐 Security Critical:**
- These private keys control real Bitcoin and funds
- Each key must be unique and securely generated
- Never reuse keys across different environments
- Consider using [GPG encryption](6.-advanced-security-setup.md) for enhanced security

### Validate Configuration

Verify your configuration before starting:

```bash
# Check environment file (without exposing secrets)
grep -E "^[A-Z_]+=" .env | grep -v "_SK=" | grep -v "PASSWORD"

# Verify database connectivity
cd dal && sqlx database create --database-url $(grep DATABASE_URL .env | cut -d '=' -f2) 2>/dev/null && echo "Database OK" || echo "Database connection failed"
cd ..

# Check Docker services
sudo docker ps | grep -E "(postgres|redis)" && echo "Containers OK" || echo "Containers not running"
```

## Starting the Operator Service

### Standard Startup (Plaintext Keys)

For production deployment with plaintext keys:

```bash
# Make startup script executable
chmod +x ./start_operator.sh

# Start the operator service
./start_operator.sh
```

The script will:
- Create a systemd service for the operator
- Configure it to run in the current directory
- Start the service automatically
- Set up proper logging
- Enable auto-restart on failure

### Advanced Startup (GPG-Encrypted Keys)

For enhanced security with GPG-encrypted keys, see [Advanced Security Setup](6.-advanced-security-setup.md).

## Service Verification

### Check Service Status

Verify the operator service is running:

```bash
# Check systemd service status
sudo systemctl status fiamma-operator

# Expected output should show:
# ● fiamma-operator.service - Fiamma Operator
#    Loaded: loaded (/etc/systemd/system/fiamma-operator.service; enabled; vendor preset: enabled)
#    Active: active (running) since...
```

### Monitor Service Logs

Monitor the operator logs for proper startup:

```bash
# View real-time logs
tail -f .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log

# Check for successful startup indicators:
# - "Service started successfully"
# - "Connected to Bitcoin network"
# - "Database connection established"
# - "Waiting for registration..."
```

### Verify Network Connectivity

Ensure the operator can connect to required networks:

```bash
# The logs should show successful connections to:
# - Bitcoin mainnet
# - Ethereum mainnet (or specified network)
# - Fiamma bridge network
# - Database and Redis services
```

## Registration Process

### Production Registration Requirements

Before registering, ensure you have:
- **Production invite code** from Fiamma team
- **Minimum stake amount** in Bitcoin ready
- **Verified identity** and authorization
- **Technical competency** demonstrated
- **Security measures** implemented

### Submit Registration

The registration process typically involves:

1. **Service Detection**: Operator automatically detects it's running
2. **Registration Interface**: Access through operator interface or API
3. **Invite Code Entry**: Provide your production invite code
4. **Identity Verification**: Complete required verification steps
5. **Stake Preparation**: Prepare for Bitcoin staking requirements

### Monitoring Registration Status

```bash
# Check registration status in logs
grep -i "registration" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log

# Look for status indicators:
# - "Registration initiated"
# - "Invite code validated"
# - "Identity verification complete"
# - "Ready for staking"
```

## Service Management

### Basic Service Commands

```bash
# Check service status
sudo systemctl status fiamma-operator

# Restart the service
sudo systemctl restart fiamma-operator

# Stop the service
sudo systemctl stop fiamma-operator

# Enable auto-start on boot
sudo systemctl enable fiamma-operator

# View service logs
sudo journalctl -u fiamma-operator -f
```

### Advanced Monitoring

```bash
# Monitor resource usage
top -p $(pgrep fiamma-operator)

# Check network connections
sudo netstat -tlnp | grep fiamma-operator

# Monitor disk usage
df -h
du -sh .logs/
```

## Production Security Considerations

### Service Security

```bash
# Ensure service runs with proper user
sudo systemctl show fiamma-operator | grep User

# Check file permissions
ls -la .env *.sh fiamma-operator

# Verify log security
ls -la .logs/ .logs/bitvm-operator/
```

### Network Security

```bash
# Check firewall status
sudo ufw status

# Monitor network traffic (if needed)
sudo tcpdump -i any port 8333  # Bitcoin network
sudo tcpdump -i any port 443   # HTTPS traffic
```

## Troubleshooting

### Service Startup Issues

```bash
# Check detailed service status
sudo systemctl status fiamma-operator -l

# View service logs
sudo journalctl -u fiamma-operator --no-pager

# Common issues and solutions:
# 1. Permission denied: Check file permissions
# 2. Database connection failed: Verify PostgreSQL
# 3. Network timeout: Check internet connectivity
# 4. Invalid configuration: Review .env file
```

### Configuration Problems

```bash
# Validate environment variables (safely)
env | grep -E "^BITVM_" | grep -v "_SK=" | head -10

# Test database connection
cd dal
sqlx migrate status
cd ..

# Check container health
sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

### Registration Issues

Common registration problems:
- **Invalid invite code**: Contact Fiamma team for valid code
- **Network connectivity**: Ensure stable internet connection
- **Service not running**: Verify operator service is active
- **Configuration errors**: Review all environment variables

## Production Deployment Best Practices

### Monitoring Setup

```bash
# Set up log monitoring
sudo apt install logwatch -y

# Configure alerts for service failures
sudo systemctl enable fiamma-operator
sudo systemctl daemon-reload
```

### Backup Procedures

```bash
# Create backup script
cat > backup_operator.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/fiamma-operator"
mkdir -p $BACKUP_DIR

# Backup configuration
cp .env $BACKUP_DIR/env_$DATE
cp -r dal/ $BACKUP_DIR/dal_$DATE/

# Backup logs (last 7 days)
find .logs/ -name "*.log" -mtime -7 -exec cp {} $BACKUP_DIR/ \;

echo "Backup completed: $BACKUP_DIR"
EOF

chmod +x backup_operator.sh
```

## Next Steps

After successful registration:

1. **Proceed to [Deposit and Stake](3.-deposit-and-stake.md)** for Bitcoin staking
2. **Set up monitoring** for production operations
3. **Implement backup** procedures
4. **Configure alerting** for critical events

## Support

For registration and startup assistance:
- **Service Issues**: Technical support team
- **Registration Problems**: Contact registration support
- **Security Questions**: Security team consultation
- **Production Support**: Priority support channels

---

**Next**: After successful startup and registration, proceed to [Deposit and Stake](3.-deposit-and-stake.md) to stake your Bitcoin for production operations.
