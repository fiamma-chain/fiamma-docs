# 1. Set Up Fiamma Operator

This guide covers the initial setup and installation of the Fiamma Operator for **mainnet production** deployment on Linux systems.

## ⚠️ Production Environment Setup

**Important**: This is for **production mainnet deployment** with real Bitcoin. Ensure you understand all security implications and have proper safeguards in place.

## Prerequisites

### System Requirements
- **Linux Distribution**: Ubuntu 20.04 LTS or later (recommended), CentOS 8+
- **Architecture**: x86_64 (AMD64)
- **CPU**: 4+ cores (8+ recommended for production)
- **RAM**: 96GB minimum (96GB+ recommended)
- **Storage**: 100GB SSD minimum (500GB+ recommended)
- **Network**: Stable internet connection with low latency

### Security Prerequisites
- **Secure environment**: Hardened Linux system
- **Firewall configuration**: Proper port management
- **User access**: Limited sudo access
- **Backup strategy**: Established and tested
- **Monitoring**: System monitoring tools installed

## Installation Steps

### Step 1: Clone the Repository

Clone the production repository to your secure server:

```bash
# Navigate to your secure installation directory
cd /opt  # or your preferred secure location

# Clone the repository
git clone https://github.com/fiamma-chain/operator-release.git

# Verify the download
ls -la operator-release/
```

### Step 2: Extract and Setup Operator

Extract the production operator package:

```bash
# Extract the operator package
tar -zxvf operator-release/operator_for_linux/FiammaOperator.1.4.x.tar.gz -C operator-release --strip-components=1

# Move to working directory
mv operator-release/ operator_for_linux/

# Navigate to the operator directory
cd operator_for_linux/

# Verify contents
ls -la
```

### Step 3: Environment Preparation

Run the setup script to install all dependencies:

```bash
# Make setup script executable
chmod +x ./setup.sh

# Run setup (will require sudo access)
./setup.sh
```

**The setup script will:**
- Install required packages (build-essential, gcc, g++, libssl-dev)
- Install and configure PostgreSQL database
- Install Docker and Docker Compose
- Install Rust toolchain and SQLx CLI
- Create default .env file from template
- Start database and Redis containers
- Set proper permissions on scripts

### Step 4: Enable Rust Environment

After the first execution of `setup.sh`, enable Rust environment:

```bash
# Source Rust environment
source "$HOME/.cargo/env"

# Or restart your terminal session
# source ~/.bashrc    # for bash users
# source ~/.zshrc     # for zsh users
```

### Step 5: Database Setup

Set up the database schema:

```bash
# Navigate to database directory
cd dal

# Copy environment template
cp .env.example .env

# Run database migrations
sqlx migrate run

# Return to main directory
cd ..
```

### Step 6: Verify Installation

Verify all components are properly installed:

```bash
# Check Docker containers
sudo docker ps | grep -E "(postgres|redis)"

# Verify Rust installation
rustc --version
cargo --version

# Check SQLx CLI
sqlx --version

# Verify operator binary
ls -la fiamma-operator
./fiamma-operator --version
```

## Configuration Files

### Environment Configuration
The setup creates several important files:

```bash
# Main environment configuration
.env                    # Primary configuration file
.env_example           # Template with default values

# Database configuration
dal/.env               # Database-specific settings

# Service configurations
start_operator.sh      # Standard service startup
start_operator_encrypt.sh  # GPG-encrypted startup (advanced)
```

### Security File Permissions

Ensure proper file permissions for security:

```bash
# Set secure permissions on configuration files
chmod 600 .env
chmod 600 dal/.env

# Set executable permissions on scripts
chmod +x *.sh

# Set proper permissions on operator binary
chmod +x fiamma-operator

# Verify permissions
ls -la .env* *.sh fiamma-operator
```

## Production Security Hardening

### System Security
```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Configure automatic security updates
sudo apt install unattended-upgrades -y
sudo dpkg-reconfigure unattended-upgrades

# Configure firewall (adjust ports as needed)
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 8080  # If web interface needed
sudo ufw enable
```

### Database Security
```bash
# Secure PostgreSQL installation
sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'your_secure_password';"

# Update database configuration
vim dal/.env
# Set strong DATABASE_URL with secure password
```

### File System Security
```bash
# Create secure backup directory
sudo mkdir -p /var/backups/fiamma-operator
sudo chown $(whoami):$(whoami) /var/backups/fiamma-operator
chmod 700 /var/backups/fiamma-operator

# Set up log rotation
sudo vim /etc/logrotate.d/fiamma-operator
```

## Troubleshooting Installation

### Common Issues

#### Docker Permission Issues
```bash
# Add user to docker group
sudo usermod -aG docker $USER
newgrp docker

# Test docker access
docker ps
```

#### Database Connection Issues
```bash
# Check PostgreSQL status
sudo systemctl status postgresql

# Test database connection
sudo -u postgres psql -l

# Restart database if needed
sudo systemctl restart postgresql
```

#### Rust Installation Issues
```bash
# Reinstall Rust if needed
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source ~/.cargo/env

# Update Rust components
rustup update
```

### Verification Commands
```bash
# Comprehensive system check
./setup.sh --verify  # If available

# Manual verification
echo "=== Docker Status ==="
sudo docker ps | grep -E "(postgres|redis)"

echo "=== Database Connection ==="
cd dal && sqlx database create --database-url $(grep DATABASE_URL .env | cut -d '=' -f2) && cd ..

echo "=== Rust Environment ==="
rustc --version && cargo --version

echo "=== File Permissions ==="
ls -la .env* *.sh fiamma-operator
```

## Next Steps

After successful setup:

1. **Review configuration** in `.env` file
2. **Plan security strategy** (standard or GPG-encrypted keys)
3. **Proceed to [Start and Register](2.-start-and-register.md)**
4. **Set up monitoring** and alerting systems

## Production Deployment Notes

### Cloud Deployment Considerations
- **Instance types**: Use compute-optimized instances
- **Storage**: Use SSD-backed storage for database
- **Networking**: Configure VPC with proper security groups
- **Monitoring**: Set up CloudWatch/monitoring from the start
- **Backup**: Automated backup to S3 or equivalent

### High Availability Setup
- **Multiple zones**: Deploy across availability zones
- **Load balancing**: For high-traffic scenarios
- **Database clustering**: For critical production loads
- **Disaster recovery**: Cross-region backup strategy

## Support

For setup assistance:
- **Installation Issues**: Technical support team
- **Security Questions**: Security consultation available
- **Production Planning**: Architecture review services
- **Emergency Setup**: Priority support for urgent deployments

---

**Next**: After successful setup, proceed to [Start and Register](2.-start-and-register.md) to configure and register your operator.
