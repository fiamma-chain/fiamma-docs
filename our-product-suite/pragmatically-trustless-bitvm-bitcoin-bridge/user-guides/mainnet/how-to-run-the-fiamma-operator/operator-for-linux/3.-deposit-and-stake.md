# 3. Deposit and Stake

This guide covers depositing and staking **real Bitcoin** for mainnet production operator participation.

## âš ï¸ Real Bitcoin Staking - Production Environment

**Critical Warning**: This process involves **real Bitcoin** with significant financial implications. Understand all risks, requirements, and procedures before proceeding.

## Overview

Staking Bitcoin is required for operator participation in the mainnet bridge. Your stake:
- **Secures the network** and demonstrates commitment
- **Enables operator rewards** from bridge operations
- **Subject to slashing** if malicious behavior is detected
- **Has lock-up periods** and withdrawal requirements

## Prerequisites

Before staking Bitcoin:
- **Operator successfully registered** from [previous step](2.-start-and-register.md)
- **Service running and healthy**
- **Real Bitcoin** available for staking
- **Understanding of staking risks** and requirements
- **Emergency procedures** documented and understood

## Staking Requirements

### Minimum Stake Amounts

```
Production Mainnet Staking:
- Minimum Stake: [Contact team for current requirements]
- Recommended: [Contact team for current requirements]
- Additional: Transaction fees and operational buffer
```

**Note**: Exact staking amounts are subject to network parameters and may change. Contact the Fiamma team for current requirements.

### Bitcoin Wallet Requirements
- **Secure wallet** with adequate Bitcoin balance
- **Hardware wallet** recommended for large amounts
- **Multiple confirmations** capability
- **Fee estimation** tools available

## Staking Process

### Step 1: Generate Staking Address

Access the operator interface to generate a staking address:

```bash
# Check operator status first
sudo systemctl status fiamma-operator

# Monitor logs for staking address generation
tail -f .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | grep -i stake

# Or access through operator API/interface (if available)
curl -X GET http://localhost:8080/api/stake/address  # Example endpoint
```

### Step 2: Verify Staking Address

**Critical**: Always verify the staking address through multiple channels:

```bash
# Verify address format (should be valid Bitcoin mainnet address)
# - Starts with '1', '3', or 'bc1' for mainnet
# - Never starts with 'tb1', 'm', or 'n' (those are testnet)

# Cross-reference with operator logs
grep -i "staking.*address" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log

# Contact Fiamma team for address verification if uncertain
```

### Step 3: Send Bitcoin Stake

**Security Checklist Before Sending**:
- âœ… Address verified through multiple sources
- âœ… Amount calculated including fees
- âœ… Using mainnet Bitcoin (not testnet)
- âœ… Backup of wallet and recovery phrases
- âœ… Understanding of lock-up periods

```bash
# Using your Bitcoin wallet:
# 1. Send exact stake amount to generated address
# 2. Use appropriate fee rate for timely confirmation
# 3. Save transaction hash for tracking
# 4. Wait for required confirmations (typically 6+ for mainnet)
```

### Step 4: Monitor Confirmation

Track the staking transaction progress:

```bash
# Monitor operator logs for transaction detection
tail -f .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | grep -i "transaction\|confirm"

# Check Bitcoin blockchain explorer
# https://blockstream.info/tx/[your_transaction_hash]

# Verify in operator dashboard (if available)
# Look for stake status changes: Pending â†’ Confirming â†’ Active
```

## Stake Management

### Monitoring Stake Status

```bash
# Check current stake status
grep -i "stake.*status" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -5

# Monitor stake-related metrics
# - Current stake amount
# - Stake status (Pending/Active/Locked)
# - Lock-up period remaining
# - Accumulated rewards (if applicable)
```

### Stake States

```
Stake Lifecycle:
ğŸ”„ Pending     - Transaction sent, awaiting confirmations
â³ Confirming  - Accumulating required confirmations
âœ… Active      - Stake confirmed and active
ğŸ”’ Locked      - In lock-up period, cannot withdraw
âš ï¸ Slashed     - Penalties applied for violations
ğŸ“¤ Withdrawing - Withdrawal initiated
âœ… Withdrawn   - Stake successfully withdrawn
```

## Production Considerations

### Financial Risk Management

**Staking Risks**:
- **Market risk**: Bitcoin price volatility affects stake value
- **Slashing risk**: Penalties for malicious or faulty behavior
- **Lock-up risk**: Inability to withdraw during lock period
- **Technical risk**: Service failures affecting rewards

**Risk Mitigation**:
- **Start with minimum stakes** to gain experience
- **Implement robust monitoring** for service health
- **Maintain operational excellence** to avoid slashing
- **Plan for various market scenarios**

### Operational Excellence

```bash
# Daily stake monitoring routine
echo "=== Daily Stake Report ===" >> daily_reports/stake_$(date +%Y%m%d).log
echo "Timestamp: $(date)" >> daily_reports/stake_$(date +%Y%m%d).log
grep -i "stake\|reward\|penalty" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -10 >> daily_reports/stake_$(date +%Y%m%d).log

# Monitor service health
systemctl --user status fiamma-operator >> daily_reports/stake_$(date +%Y%m%d).log

# Check system resources
echo "System Resources:" >> daily_reports/stake_$(date +%Y%m%d).log
df -h >> daily_reports/stake_$(date +%Y%m%d).log
free -m >> daily_reports/stake_$(date +%Y%m%d).log
```

### Backup and Recovery

```bash
# Create comprehensive backup before staking
mkdir -p /var/backups/fiamma-operator/pre-stake/$(date +%Y%m%d)

# Backup configuration
cp .env /var/backups/fiamma-operator/pre-stake/$(date +%Y%m%d)/
cp -r dal/ /var/backups/fiamma-operator/pre-stake/$(date +%Y%m%d)/

# Backup service configuration
sudo cp /etc/systemd/system/fiamma-operator* /var/backups/fiamma-operator/pre-stake/$(date +%Y%m%d)/ 2>/dev/null || true

# Document stake transaction details
cat > /var/backups/fiamma-operator/pre-stake/$(date +%Y%m%d)/stake_details.txt << EOF
Stake Date: $(date)
Transaction Hash: [ENTER_YOUR_TX_HASH]
Stake Amount: [ENTER_AMOUNT] BTC
Staking Address: [ENTER_ADDRESS]
Operator ID: [ENTER_OPERATOR_ID]
EOF
```

## Troubleshooting

### Common Staking Issues

#### Transaction Not Detected
```bash
# Check Bitcoin network connectivity
grep -i "bitcoin.*connect" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log

# Verify transaction on blockchain
# Use multiple block explorers to confirm transaction exists

# Check operator configuration
grep -i "network\|chain" .env | grep -v "_SK="
```

#### Insufficient Confirmations
```bash
# Monitor confirmation progress
# Most operators require 6+ confirmations for mainnet

# Check if transaction has proper fee
# Low fees may delay confirmations significantly

# Wait patiently - Bitcoin blocks average 10 minutes
```

#### Address Verification Failure
```bash
# Double-check address format
# Mainnet addresses: 1xxx, 3xxx, bc1xxx
# NEVER use testnet addresses: mxxx, nxxx, tb1xxx

# Contact support immediately if address seems incorrect
# Better to delay than lose funds to wrong address
```

### Emergency Procedures

#### Service Issues During Staking
```bash
# If service fails after staking transaction sent:
# 1. Don't panic - your Bitcoin is still yours
# 2. Check transaction status on blockchain
# 3. Restart operator service
sudo systemctl restart fiamma-operator

# 4. Monitor logs for recovery
tail -f .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log

# 5. Contact support with transaction details if needed
```

## Advanced Staking Strategies

### Multiple Stake Management
- **Diversification**: Spread stakes across time periods
- **Risk management**: Start small, scale gradually
- **Performance optimization**: Monitor reward rates
- **Withdrawal planning**: Stagger unlock periods

### Stake Optimization
```bash
# Monitor network stake distribution
# Look for optimal stake sizes for rewards
# Track operator performance metrics
# Plan stake increases based on proven performance
```

## Next Steps

After successful staking:

1. **Proceed to [Query Operator Status](4.-query-operator-status.md)** for monitoring
2. **Set up comprehensive monitoring** for stake and rewards
3. **Implement alerting** for critical stake events
4. **Plan operational procedures** for ongoing management

## Support

For staking assistance:
- **Staking Questions**: Financial operations team
- **Technical Issues**: Technical support
- **Risk Management**: Risk advisory services
- **Emergency Support**: 24/7 priority support for stake-related issues

---

**Critical Reminder**: You are working with real Bitcoin in a production environment. Always verify addresses, understand risks, and have emergency procedures ready. When in doubt, contact the Fiamma team before proceeding.
