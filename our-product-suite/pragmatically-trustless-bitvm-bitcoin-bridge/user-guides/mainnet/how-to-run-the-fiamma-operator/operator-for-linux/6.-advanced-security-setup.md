# 6. Advanced Security Setup

## 🔐 GPG-Encrypted Private Keys for Production

This guide covers the enhanced security setup using GPG-encrypted private keys with automatic agent caching for **mainnet production** environments.

## Overview

The GPG encryption feature provides enhanced security for production deployments by:
- **Encrypting private keys at rest** using GPG
- **Automatic decryption** via gpg-agent cache
- **Supporting systemd auto-restarts** without manual intervention
- **Maintaining compatibility** with the existing plaintext workflow

## Benefits of GPG Encryption

### Security Advantages
- **Private keys never stored in plaintext** on disk
- **Strong encryption** using industry-standard GPG
- **Automatic cache management** for operational efficiency
- **Audit trails** for key access and usage

### Operational Benefits
- **24/7 operation** without manual intervention
- **Automatic service restarts** on failure
- **Long-term key caching** (configurable TTL)
- **Compatible with existing monitoring** and management tools

## Prerequisites

Before implementing GPG encryption:
- **Operator successfully running** with plaintext keys
- **Root or sudo access** for system configuration
- **GPG installed** and configured on the system
- **Understanding of GPG concepts** and key management

### Install Required Packages

```bash
# Install GPG and related tools (Ubuntu/Debian)
sudo apt update
sudo apt install -y gnupg2 pinentry-curses

# For CentOS/RHEL
sudo yum install -y gnupg2 pinentry-curses

# Verify installation
gpg --version
```

## Step A: Generate Encrypted Keys

### 1. Prepare Temporary Plaintext File

⚠️ **Critical Security Notes**: This step involves creating a temporary file with plaintext private keys. Handle with extreme care.

```bash
# Create secure temporary file
cat > /tmp/keys.env << 'EOF'
BITVM_BRIDGE_OPERATOR_AUTH_SK="your_production_auth_wif"
BITVM_BRIDGE_OPERATOR_PEGIN_SK="your_production_pegin_wif"
BITVM_BRIDGE_OPERATOR_PEGOUT_SK="your_production_pegout_wif"
BITVM_BRIDGE_OPERATOR_ETH_SK="0xYourProductionEvmPrivateKey"
EOF

# Set strict permissions immediately
chmod 600 /tmp/keys.env
```

**🚨 Security Warning for /tmp/keys.env:**
- **Contains plaintext private keys** - extremely sensitive
- **Keep for minimal time** - only during encoding process
- **Use secure deletion** when finished: `shred -u /tmp/keys.env`
- **Avoid editors** that create backup/swap files
- **Never commit** to repositories or backups
- **Use in secure environment** only

### 2. Encrypt Using CLI Encoder

```bash
# Optional: Set passphrase as environment variable
# export BCLI_PASSWORD='your-very-strong-passphrase'

# Encrypt the keys
./bcli encode -i /tmp/keys.env -o ./gpg.env.encode

# The encoder will:
# - Prompt for a strong passphrase (if not set via environment)
# - Encrypt each key individually with GPG
# - Output BASE64-encoded ciphertexts
# - Create ./gpg.env.encode with encrypted values
```

### 3. Enable GPG Mode

Add GPG configuration flags to your `.env` file:

```bash
# Enable GPG features
echo 'BITVM_BRIDGE_USE_GPG_KEYS=1' >> ./.env
echo 'BITVM_BRIDGE_USE_GPG_AGENT=1' >> ./.env
```

### 4. Update Environment with Encrypted Values

Replace the plaintext keys in `.env` with encrypted versions:

```bash
# Automated replacement of encrypted keys
sed -n 's/^\(BITVM_BRIDGE_OPERATOR_.*_SK\)=.*$/\1/p' ./gpg.env.encode | while read -r key; do
  val=$(grep "^$key=" ./gpg.env.encode | cut -d '"' -f2)
  # Update .env file in-place
  sed -i "s#^$key=.*#$key=\"$val\"#" ./.env
done

# Verify the encrypted keys are in place
grep "BITVM_BRIDGE_OPERATOR.*_SK=" .env | head -2
```

### 5. Secure Deletion of Temporary File

**Critical**: Securely delete the temporary plaintext file:

```bash
# Secure deletion of temporary file
shred -u /tmp/keys.env

# Verify file is gone
ls -la /tmp/keys.env  # Should show "No such file or directory"
```

## Step B: Configure GPG Agent Cache

### 1. Configure GPG Agent Settings

Set up long-term caching for production operations:

```bash
# Create GPG agent configuration
mkdir -p ~/.gnupg
cat > ~/.gnupg/gpg-agent.conf << 'EOF'
# Cache settings for production (6 months)
default-cache-ttl 15552000
max-cache-ttl 15552000

# Use curses pinentry for server environments
pinentry-program /usr/bin/pinentry-curses

# Enable logging for debugging (optional)
# log-file ~/.gnupg/gpg-agent.log
# debug-level basic
EOF

# Set proper permissions
chmod 700 ~/.gnupg
chmod 600 ~/.gnupg/gpg-agent.conf
```

### 2. Reload GPG Agent

Apply the new configuration:

```bash
# Kill existing agent
gpgconf --kill gpg-agent || true

# Reload agent with new configuration
gpg-connect-agent reloadagent /bye || true

# Verify agent is running
gpg-connect-agent 'keyinfo --list' /bye
```

### 3. Pre-warm Cache (Interactive)

**Important**: This step must be done interactively in a terminal with TTY:

```bash
# Set TTY for GPG interaction
export GPG_TTY=$(tty)

# Pre-warm cache with one encrypted key
VAL=$(grep "^BITVM_BRIDGE_OPERATOR_AUTH_SK=" .env | cut -d '"' -f2)
printf "%s" "$VAL" | base64 -d | gpg --decrypt >/dev/null

# You will be prompted for your passphrase
# Enter the same passphrase used during encryption
```

### 4. Verify Non-Interactive Decryption

Test that cached decryption works without prompts:

```bash
# Test non-interactive decryption
VAL=$(grep "^BITVM_BRIDGE_OPERATOR_AUTH_SK=" .env | cut -d '"' -f2)
printf "%s" "$VAL" | base64 -d | gpg --decrypt --batch --quiet >/dev/null

# Should complete without prompts
if [ $? -eq 0 ]; then
    echo "✅ GPG Cache OK - Ready for production"
else
    echo "❌ GPG Cache FAIL - Check configuration"
fi
```

## Step C: Start with Encrypted Keys

### 1. Use Encrypted Startup Script

Switch to the GPG-encrypted startup process:

```bash
# Make encrypted startup script executable
chmod +x ./start_operator_encrypt.sh

# Stop existing service (if running)
sudo systemctl stop fiamma-operator || true

# Start with encrypted keys
./start_operator_encrypt.sh
```

### 2. Verify Encrypted Operation

```bash
# Check service status
sudo systemctl status fiamma-operator-user

# Monitor logs for successful startup with encrypted keys
tail -f .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log

# Look for indicators:
# - "GPG key decryption successful"
# - "Encrypted keys loaded"
# - "Service started with enhanced security"
```

## Production Deployment Considerations

### User-Level vs System-Level Service

**GPG-Encrypted Deployment**:
- Uses **user-level systemd** for GPG agent access
- Service runs as current user with GPG cache access
- Automatic restart on failure
- Better security isolation

**Traditional Deployment**:
- Uses **system-level systemd** (continues to work)
- Service runs as system service
- Plaintext keys in environment
- Standard service management

### Service Management Commands

```bash
# GPG-encrypted service management
systemctl --user status fiamma-operator
systemctl --user restart fiamma-operator
systemctl --user stop fiamma-operator

# Enable auto-start for user session
systemctl --user enable fiamma-operator
sudo loginctl enable-linger $USER  # For auto-start without login
```

### Cache Management

```bash
# Check cache status
gpg-connect-agent 'keyinfo --list' /bye

# Manually clear cache (if needed)
gpg-connect-agent reloadagent /bye

# Re-warm cache after clearing
export GPG_TTY=$(tty)
VAL=$(grep "^BITVM_BRIDGE_OPERATOR_AUTH_SK=" .env | cut -d '"' -f2)
printf "%s" "$VAL" | base64 -d | gpg --decrypt >/dev/null
```

## Security Best Practices

### Passphrase Management
- **Use strong passphrases** (20+ characters)
- **Store securely** using password managers
- **Regular rotation** for high-security environments
- **Document recovery procedures**

### GPG Key Management
- **Regular key backup** to secure offline storage
- **Key expiration** planning and renewal
- **Access control** for GPG keys and passphrases
- **Audit trails** for key usage

### Operational Security
- **Monitor cache status** regularly
- **Log GPG operations** for audit purposes
- **Regular security reviews** of configuration
- **Incident response** procedures for key compromise

## Troubleshooting

### Common GPG Issues

#### Cache Expired or Cleared
```bash
# Symptoms: Service starts but fails to decrypt keys
# Solution: Re-warm the cache
export GPG_TTY=$(tty)
VAL=$(grep "^BITVM_BRIDGE_OPERATOR_AUTH_SK=" .env | cut -d '"' -f2)
printf "%s" "$VAL" | base64 -d | gpg --decrypt >/dev/null
```

#### GPG Agent Not Running
```bash
# Restart GPG agent
gpgconf --kill gpg-agent
gpg-connect-agent reloadagent /bye

# Check agent status
gpg-connect-agent 'getinfo version' /bye
```

#### Permission Issues
```bash
# Fix GPG directory permissions
chmod 700 ~/.gnupg
chmod 600 ~/.gnupg/*

# Check service user permissions
systemctl --user status fiamma-operator
```

### Recovery Procedures

#### Emergency Fallback to Plaintext
If GPG system fails and immediate operation is required:

```bash
# Disable GPG flags temporarily
sed -i 's/BITVM_BRIDGE_USE_GPG_KEYS=1/BITVM_BRIDGE_USE_GPG_KEYS=0/' .env
sed -i 's/BITVM_BRIDGE_USE_GPG_AGENT=1/BITVM_BRIDGE_USE_GPG_AGENT=0/' .env

# Restore plaintext keys (from secure backup)
# Update .env with plaintext keys

# Start with standard script
./start_operator.sh
```

## Support

For GPG encryption assistance:
- **Setup Issues**: Security team consultation
- **Operational Problems**: Priority technical support
- **Key Management**: Specialized security guidance
- **Emergency Recovery**: 24/7 emergency support

---

**Next**: After implementing GPG encryption, your operator has enhanced security for production operations. Monitor the service regularly and maintain proper key management practices.
