# 8. Troubleshooting

Comprehensive troubleshooting guide for **mainnet production** Fiamma Operator issues.

## Overview

This guide covers:
- **Common production issues** and resolutions
- **Diagnostic procedures** for complex problems
- **Emergency recovery** procedures
- **Performance troubleshooting**
- **Security incident response**

## General Diagnostic Approach

### Step 1: Initial Assessment

```bash
# Quick system health check
echo "=== System Health Assessment ==="

# Service status
systemctl is-active fiamma-operator || systemctl --user is-active fiamma-operator
echo "Service Status: $(systemctl is-active fiamma-operator 2>/dev/null || systemctl --user is-active fiamma-operator 2>/dev/null)"

# System resources
echo "Disk Space:"
df -h | head -5

echo "Memory Usage:"
free -m | head -2

echo "Load Average:"
uptime
```

### Step 2: Log Analysis

```bash
# Examine recent logs for errors
echo "=== Recent Errors ==="
grep -i "error\|critical\|fatal\|panic" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -10

# Check for patterns
echo "=== Error Patterns ==="
grep -i "error" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | awk '{print $NF}' | sort | uniq -c | sort -nr
```

### Step 3: Service Diagnosis

```bash
# Detailed service status
echo "=== Service Diagnosis ==="
systemctl status fiamma-operator -l || systemctl --user status fiamma-operator -l

# Journal logs
journalctl -u fiamma-operator --no-pager | tail -20 || journalctl --user -u fiamma-operator --no-pager | tail -20
```

## Common Issues and Solutions

### 1. Service Won't Start

#### Symptoms
- Service fails to start
- Immediate exit after startup
- Error messages in logs

#### Diagnostic Steps

```bash
# Check configuration
echo "=== Configuration Check ==="
ls -la .env
head -5 .env | grep -v "_SK="

# Check dependencies
echo "=== Dependencies Check ==="
sudo docker ps | grep -E "(postgres|redis)"
rustc --version
./fiamma-operator --version
```

#### Solutions

```bash
# Solution 1: Fix configuration
vim .env  # Check for invalid values

# Solution 2: Restart dependencies
sudo docker restart $(sudo docker ps | grep postgres | awk '{print $1}')
sudo docker restart $(sudo docker ps | grep redis | awk '{print $1}')

# Solution 3: Reset service
sudo systemctl reset-failed fiamma-operator || systemctl --user reset-failed fiamma-operator
sudo systemctl restart fiamma-operator || systemctl --user restart fiamma-operator
```

### 2. Database Connection Issues

#### Symptoms
- "Database connection failed" errors
- Service starts but becomes unresponsive
- Migration failures

#### Diagnostic Steps

```bash
# Test database connectivity
echo "=== Database Diagnosis ==="
sudo docker ps | grep postgres

# Check database logs
sudo docker logs $(sudo docker ps | grep postgres | awk '{print $1}') | tail -20

# Test connection
cd dal
sqlx database ping --database-url $(grep DATABASE_URL .env | cut -d '=' -f2)
cd ..
```

#### Solutions

```bash
# Solution 1: Restart PostgreSQL
sudo docker restart $(sudo docker ps | grep postgres | awk '{print $1}')

# Solution 2: Check database credentials
cd dal
grep DATABASE_URL .env
cd ..

# Solution 3: Recreate database
cd dal
sqlx database drop --database-url $(grep DATABASE_URL .env | cut -d '=' -f2)
sqlx database create --database-url $(grep DATABASE_URL .env | cut -d '=' -f2)
sqlx migrate run
cd ..
```

### 3. Network Connectivity Issues

#### Symptoms
- "Network timeout" errors
- Bitcoin/Ethereum connection failures
- Intermittent disconnections

#### Diagnostic Steps

```bash
# Network connectivity tests
echo "=== Network Diagnosis ==="

# Internet connectivity
ping -c 3 8.8.8.8

# Bitcoin network
nc -z mainnet.bitcoin.org 8333 && echo "Bitcoin network: OK" || echo "Bitcoin network: FAILED"

# DNS resolution
nslookup bitcoin.org

# Firewall status
sudo ufw status
```

#### Solutions

```bash
# Solution 1: Check firewall
sudo ufw allow out 8333  # Bitcoin
sudo ufw allow out 443   # HTTPS
sudo ufw allow out 80    # HTTP

# Solution 2: Restart networking
sudo systemctl restart networking

# Solution 3: Check DNS
echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf
```

### 4. GPG Encryption Issues

#### Symptoms
- "GPG decryption failed" errors
- Service starts but can't access keys
- Authentication failures

#### Diagnostic Steps

```bash
# GPG diagnosis
echo "=== GPG Diagnosis ==="

# Check GPG agent
gpg-connect-agent 'keyinfo --list' /bye

# Test key decryption
VAL=$(grep "^BITVM_BRIDGE_OPERATOR_AUTH_SK=" .env | cut -d '"' -f2)
printf "%s" "$VAL" | base64 -d | gpg --decrypt --batch --quiet >/dev/null && echo "GPG: OK" || echo "GPG: FAILED"

# Check agent configuration
cat ~/.gnupg/gpg-agent.conf
```

#### Solutions

```bash
# Solution 1: Restart GPG agent
gpgconf --kill gpg-agent
gpg-connect-agent reloadagent /bye

# Solution 2: Re-warm cache
export GPG_TTY=$(tty)
VAL=$(grep "^BITVM_BRIDGE_OPERATOR_AUTH_SK=" .env | cut -d '"' -f2)
printf "%s" "$VAL" | base64 -d | gpg --decrypt >/dev/null

# Solution 3: Fix permissions
chmod 700 ~/.gnupg
chmod 600 ~/.gnupg/*
```

### 5. Performance Issues

#### Symptoms
- High CPU/memory usage
- Slow response times
- Timeout errors

#### Diagnostic Steps

```bash
# Performance diagnosis
echo "=== Performance Diagnosis ==="

# Resource usage
top -p $(pgrep fiamma-operator) -n 1
ps aux | grep fiamma-operator | grep -v grep

# I/O analysis
iostat -x 1 5

# Network analysis
ss -tulpn | grep fiamma-operator
```

#### Solutions

```bash
# Solution 1: Resource optimization
# Add swap if memory is low
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# Solution 2: Database optimization
cd dal
sudo docker exec $(sudo docker ps | grep postgres | awk '{print $1}') psql -U postgres -d fiamma_operator -c "VACUUM ANALYZE;"
cd ..

# Solution 3: Log cleanup
find .logs/ -name "*.log" -mtime +7 -delete
```

## Advanced Troubleshooting

### Debug Mode Operation

```bash
# Enable debug logging (if supported)
echo "=== Debug Mode ==="

# Backup current config
cp .env .env.backup

# Enable debug mode
echo "BITVM_BRIDGE_DEBUG=1" >> .env
echo "BITVM_BRIDGE_LOG_LEVEL=debug" >> .env

# Restart with debug
sudo systemctl restart fiamma-operator || systemctl --user restart fiamma-operator

# Monitor debug logs
tail -f .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | grep -i debug
```

### System-Level Diagnosis

```bash
# Create comprehensive diagnostic script
cat > comprehensive_diagnosis.sh << 'EOF'
#!/bin/bash

echo "=== Comprehensive System Diagnosis - $(date) ==="

echo "--- System Information ---"
uname -a
cat /etc/os-release | head -5

echo "--- Service Status ---"
systemctl status fiamma-operator 2>/dev/null || systemctl --user status fiamma-operator 2>/dev/null

echo "--- Resource Usage ---"
free -m
df -h
uptime

echo "--- Network Status ---"
ip route show default
ss -s

echo "--- Docker Services ---"
sudo docker ps | grep -E "(postgres|redis)"

echo "--- Recent Errors ---"
grep -i "error\|critical" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -20

echo "--- Configuration Status ---"
ls -la .env *.sh fiamma-operator
du -sh .logs/

echo "=== Diagnosis Complete ==="
EOF

chmod +x comprehensive_diagnosis.sh
```

### Stake-Related Issues

#### Symptoms
- Stake not detected
- Withdrawal failures
- Reward calculation errors

#### Diagnostic Steps

```bash
# Stake diagnosis
echo "=== Stake Diagnosis ==="

# Check recent stake activity
grep -i "stake\|deposit\|withdraw" .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | tail -20

# Check Bitcoin transactions
echo "Check your transactions on: https://blockstream.info/"

# Verify stake configuration
grep -i "stake\|bitcoin" .env | grep -v "_SK="
```

#### Solutions

```bash
# Solution 1: Resync Bitcoin data
# (Implementation depends on operator design)
echo "Consider resyncing Bitcoin blockchain data"

# Solution 2: Verify transaction
echo "Verify your stake transaction on blockchain explorer"
echo "Contact support with transaction hash if needed"

# Solution 3: Check lock periods
echo "Verify withdrawal lock periods haven't expired"
```

## Emergency Recovery Procedures

### Service Recovery

```bash
# Emergency service recovery
cat > emergency_recovery.sh << 'EOF'
#!/bin/bash

echo "=== EMERGENCY RECOVERY - $(date) ==="

# Stop everything
sudo systemctl stop fiamma-operator || systemctl --user stop fiamma-operator
pkill -f fiamma-operator || echo "No processes to kill"

# Backup current state
RECOVERY_BACKUP="/var/backups/fiamma-operator/emergency_recovery/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$RECOVERY_BACKUP"
cp .env "$RECOVERY_BACKUP/" 2>/dev/null || echo "No .env to backup"
cp -r dal/ "$RECOVERY_BACKUP/" 2>/dev/null || echo "No dal/ to backup"
tail -100 .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log > "$RECOVERY_BACKUP/recent_logs.txt" 2>/dev/null

# Reset service
sudo systemctl reset-failed fiamma-operator || systemctl --user reset-failed fiamma-operator

# Restart dependencies
sudo docker restart $(sudo docker ps -q)

# Wait for services
sleep 30

# Restart operator
sudo systemctl start fiamma-operator || systemctl --user start fiamma-operator

# Monitor startup
sleep 10
systemctl status fiamma-operator || systemctl --user status fiamma-operator

echo "Recovery backup: $RECOVERY_BACKUP"
echo "=== Emergency Recovery Complete ==="
EOF

chmod +x emergency_recovery.sh
```

### Data Recovery

```bash
# Data recovery from backup
cat > recover_from_backup.sh << 'EOF'
#!/bin/bash

if [ $# -ne 1 ]; then
    echo "Usage: $0 <backup_directory>"
    echo "Available backups:"
    ls -la /var/backups/fiamma-operator/ | grep drwx
    exit 1
fi

BACKUP_DIR="$1"
echo "=== Data Recovery from $BACKUP_DIR ==="

# Stop service
sudo systemctl stop fiamma-operator || systemctl --user stop fiamma-operator

# Restore configuration
cp "$BACKUP_DIR/.env" ./
cp -r "$BACKUP_DIR/dal/" ./

# Restore database if available
if [ -f "$BACKUP_DIR/database_backup.sql" ]; then
    sudo docker exec -i $(sudo docker ps | grep postgres | awk '{print $1}') psql -U postgres -d fiamma_operator < "$BACKUP_DIR/database_backup.sql"
fi

# Start service
sudo systemctl start fiamma-operator || systemctl --user start fiamma-operator

echo "=== Recovery Complete ==="
EOF

chmod +x recover_from_backup.sh
```

## Security Incident Response

### Suspected Compromise

```bash
# Security incident response
cat > security_incident_response.sh << 'EOF'
#!/bin/bash

echo "=== SECURITY INCIDENT RESPONSE - $(date) ==="
echo "INCIDENT TYPE: $1"

# Immediate containment
sudo systemctl stop fiamma-operator || systemctl --user stop fiamma-operator
sudo ufw deny incoming
sudo ufw deny outgoing

# Preserve evidence
INCIDENT_DIR="/var/backups/fiamma-operator/security_incident/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$INCIDENT_DIR"

# Capture system state
ps aux > "$INCIDENT_DIR/processes.txt"
netstat -tulpn > "$INCIDENT_DIR/network_connections.txt"
last -n 50 > "$INCIDENT_DIR/login_history.txt"
tail -200 /var/log/auth.log > "$INCIDENT_DIR/auth_logs.txt" 2>/dev/null || echo "No auth logs"

# Capture operator state
cp .env "$INCIDENT_DIR/" 2>/dev/null || echo "No .env found"
cp -r .logs/ "$INCIDENT_DIR/" 2>/dev/null || echo "No logs found"

# Alert
echo "SECURITY INCIDENT on $(hostname): $1" | mail -s "SECURITY INCIDENT" security@yourdomain.com 2>/dev/null || echo "Email alert failed"

echo "Evidence preserved in: $INCIDENT_DIR"
echo "Contact security team immediately"
echo "DO NOT restart services until investigation complete"
EOF

chmod +x security_incident_response.sh
```

## Support Escalation

### When to Contact Support

**Immediate Escalation (24/7)**:
- Stake at risk of slashing
- Suspected security compromise
- Service down > 1 hour
- Data corruption detected

**Regular Support**:
- Configuration questions
- Performance optimization
- Feature requests
- General troubleshooting

### Support Information Package

```bash
# Create support package
cat > create_support_package.sh << 'EOF'
#!/bin/bash

SUPPORT_PACKAGE="/tmp/fiamma_support_$(date +%Y%m%d_%H%M%S).tar.gz"
TEMP_DIR="/tmp/support_package_$(date +%Y%m%d_%H%M%S)"

mkdir -p "$TEMP_DIR"

echo "=== Creating Support Package ==="

# System information
uname -a > "$TEMP_DIR/system_info.txt"
cat /etc/os-release >> "$TEMP_DIR/system_info.txt"

# Service status
systemctl status fiamma-operator > "$TEMP_DIR/service_status.txt" 2>&1 || systemctl --user status fiamma-operator > "$TEMP_DIR/service_status.txt" 2>&1

# Recent logs (without sensitive data)
tail -200 .logs/bitvm-operator/bitvm-operator.$(date +%Y-%m-%d).log | grep -v "_SK=" > "$TEMP_DIR/recent_logs.txt"

# Configuration (sanitized)
grep -E "^[A-Z_]+=" .env | grep -v "_SK=" > "$TEMP_DIR/configuration.txt"

# System resources
free -m > "$TEMP_DIR/memory.txt"
df -h > "$TEMP_DIR/disk.txt"
top -b -n 1 | head -20 > "$TEMP_DIR/processes.txt"

# Create package
cd /tmp
tar czf "$SUPPORT_PACKAGE" "support_package_$(date +%Y%m%d_%H%M%S)/"
rm -rf "$TEMP_DIR"

echo "Support package created: $SUPPORT_PACKAGE"
echo "Send this package to Fiamma support"
EOF

chmod +x create_support_package.sh
```

## Prevention and Monitoring

### Proactive Monitoring

```bash
# Set up proactive monitoring
cat > setup_monitoring.sh << 'EOF'
#!/bin/bash

echo "=== Setting up Proactive Monitoring ==="

# Create monitoring cron jobs
(crontab -l 2>/dev/null; echo "*/5 * * * * cd $(pwd) && ./check_operator_status.sh >> /var/log/operator_monitoring.log 2>&1") | crontab -

# Create daily health report
(crontab -l 2>/dev/null; echo "0 9 * * * cd $(pwd) && ./comprehensive_diagnosis.sh | mail -s 'Daily Operator Health Report' admin@yourdomain.com") | crontab -

# Set up log rotation
sudo tee /etc/logrotate.d/fiamma-operator << 'LOGROTATE'
/path/to/operator/.logs/bitvm-operator/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
}
LOGROTATE

echo "Monitoring setup complete"
EOF

chmod +x setup_monitoring.sh
```

## Final Notes

### Best Practices for Troubleshooting

1. **Always backup** before making changes
2. **Document issues** and solutions for future reference
3. **Test solutions** in non-production environments when possible
4. **Monitor continuously** after applying fixes
5. **Keep support contacts** readily available

### Troubleshooting Checklist

```
□ Initial system health check completed
□ Recent logs analyzed
□ Service status verified
□ Network connectivity tested
□ Resource usage checked
□ Dependencies verified
□ Configuration validated
□ Backup created before changes
□ Solution applied and tested
□ Monitoring resumed
□ Issue documented
```

---

**Support Contacts**:
- **Emergency (Stake at Risk)**: [Priority support contact]
- **Technical Issues**: [Technical support contact]
- **Security Incidents**: [Security team contact]
- **General Support**: [General support contact]

This completes the comprehensive troubleshooting guide for production Fiamma Operator deployment.
